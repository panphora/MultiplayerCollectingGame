this.kontra={init:function(t){var e=this.canvas=document.getElementById(t)||t||document.querySelector("canvas");if(!this._isCanvas(e))throw Error("You must provide a canvas element for the game");this.context=e.getContext("2d")},_noop:new Function,_isString:function(t){return""+t===t},_isNumber:function(t){return+t===t},_isFunc:function(t){return"function"==typeof t},_isImage:function(t){return!!t&&"IMG"===t.nodeName||this._isCanvas(t)},_isCanvas:function(t){return!!t&&"CANVAS"===t.nodeName}},function(t){function e(){for(var t=[],e=0;e<arguments.length;e++)arguments[e]&&t.push(arguments[e].trim().replace(new RegExp("(^[/]{"+(t[0]?1:2)+",}|[/]*$)","g"),""));return t.join("/")}function i(t){return t.split(".").pop()}function n(t){var e=t.replace("."+i(t),"");return 0==e.indexOf("/")&&0==e.lastIndexOf("/")?e.substr(1):e}function r(i){var r=n(i),s=new Image,a=kontra.assets,o=a.images;return i=e(a.imagePath,i),new t(function(t,e){s.onload=function(){o[r]=o[i]=this,t(this)},s.onerror=function(){e("Unable to load image "+i)},s.src=i})}function s(r){var s,a,o,h,c,u=kontra.assets,f=u.audio,l=u.audioPath;return Array.isArray(r)||(r=[r]),new t(function(t,u){for(c=0;s=r[c];c++)if(d[i(s)]){o=s;break}o?(a=n(o),h=new Audio,s=e(l,o),h.addEventListener("canplay",function(){f[a]=f[s]=this,t(this)}),h.onerror=function(){u("Unable to load audio "+s)},h.src=s,h.load()):u("cannot play any of the audio formats provided")})}function a(i){var r=n(i),s=new XMLHttpRequest,a=kontra.assets,o=a.data;return i=e(a.dataPath,i),new t(function(t,e){s.addEventListener("load",function(){var n=s.responseText;if(200!==s.status)return e(n);try{n=JSON.parse(n)}catch(a){}o[r]=o[i]=n,t(n)}),s.open("GET",i,!0),s.send()})}var o=/(jpeg|jpg|gif|png)$/,h=/(wav|mp3|ogg|aac)$/,c=/^no$/,u=new Audio,d={wav:"",mp3:u.canPlayType("audio/mpeg;").replace(c,""),ogg:u.canPlayType('audio/ogg; codecs="vorbis"').replace(c,""),aac:u.canPlayType("audio/aac;").replace(c,"")};kontra.assets={images:{},audio:{},data:{},imagePath:"",audioPath:"",dataPath:"",load:function(){var e,n,c,u,d,f=[];for(u=0;c=arguments[u];u++)e=Array.isArray(c)?c[0]:c,n=i(e),d=n.match(o)?r(c):n.match(h)?s(c):a(c),f.push(d);return t.all(f)},_canUse:d}}(Promise),function(t,e,i){t.gameLoop=function(n){function r(){if(a=e(r),o=i.now(),h=o-s,s=o,!(h>1e3)){for(u+=h;u>=d;)m.update(f),u-=d;l(),m.render()}}if(n=n||{},!t._isFunc(n.update)||!t._isFunc(n.render))throw Error("You must provide update() and render() functions");var s,a,o,h,c=n.fps||60,u=0,d=1e3/c,f=1/c,l=n.clearCanvas===!1?t._noop:function(){t.context.clearRect(0,0,t.canvas.width,t.canvas.height)},m={update:n.update,render:n.render,isStopped:!0,start:function(){s=i.now(),this.isStopped=!1,e(r)},stop:function(){this.isStopped=!0,cancelAnimationFrame(a)},_frame:r,set _last(t){s=t}};return m}}(kontra,requestAnimationFrame,performance),function(){function t(t){var e=s[t.which];r[e]=!0,n[e]&&n[e](t)}function e(t){var e=s[t.which];r[e]=!1}function i(t){r={}}for(var n={},r={},s={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",91:"leftwindow",92:"rightwindow",93:"select",144:"numlock",145:"scrolllock",106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},a=0;a<26;a++)s[65+a]=(10+a).toString(36);for(a=0;a<10;a++)s[48+a]=""+a,s[96+a]="numpad"+a;for(a=1;a<20;a++)s[111+a]="f"+a;var o=window.addEventListener;o("keydown",t),o("keyup",e),o("blur",i),kontra.keys={bind:function(t,e){t=Array.isArray(t)?t:[t];for(var i,r=0;i=t[r];r++)n[i]=e},unbind:function(t){t=Array.isArray(t)?t:[t];for(var e,i=0;e=t[i];i++)n[e]=null},pressed:function(t){return!!r[t]}}}(),function(t){t.pool=function(e){e=e||{};var i,n=0,r=0;if(!t._isFunc(e.create)||!(i=e.create())||!(t._isFunc(i.update)&&t._isFunc(i.init)&&t._isFunc(i.isAlive)))throw Error("Must provide create() function which returns an object with init(), update(), and isAlive() functions");return{create:e.create,objects:[i],size:1,maxSize:e.maxSize||1/0,get:function(t){if(t=t||{},this.objects[0].isAlive()){if(this.size===this.maxSize)return;for(var e=0;e<this.size&&this.objects.length<this.maxSize;e++)this.objects.unshift(this.create());this.size=this.objects.length,n=this.size-1}var i=this.objects[0];i.init(t);for(var s=1;s<this.size;s++)this.objects[s-1]=this.objects[s];this.objects[n]=i,r++},getAliveObjects:function(){return this.objects.slice(this.objects.length-r)},clear:function(){r=n=this.objects.length=0,this.size=1,this.objects.push(this.create())},update:function(t){for(var e,i=n,s=Math.max(this.objects.length-r,0);i>=s;)if(e=this.objects[i],e.update(t),e.isAlive())i--;else{for(var a=i;a>0;a--)this.objects[a]=this.objects[a-1];this.objects[0]=e,r--,s++}},render:function(){for(var t=Math.max(this.objects.length-r,0),e=n;e>=t;e--)this.objects[e].render&&this.objects[e].render()}}}}(kontra),function(t){t.quadtree=function(e){var i=Object.create(t.quadtree.prototype);return i._init(e),i},t.quadtree.prototype={_init:function(e){e=e||{},this.maxDepth=e.maxDepth||3,this.maxObjects=e.maxObjects||25,this._branch=!1,this._depth=e.depth||0,this._parent=e.parent,this.bounds=e.bounds||{x:0,y:0,width:t.canvas.width,height:t.canvas.height},this.objects=[],this.subnodes=[]},clear:function(){if(this._branch)for(var t=0;t<4;t++)this.subnodes[t].clear();this._branch=!1,this.objects.length=0},get:function(t){for(var e,i,n=[];this.subnodes.length&&this._branch;){for(e=this._getIndex(t),i=0;i<e.length;i++)n.push.apply(n,this.subnodes[e[i]].get(t));return n}return this.objects},add:function(){var t,e,i,n;for(e=0;e<arguments.length;e++)if(i=arguments[e],Array.isArray(i))this.add.apply(this,i);else if(this.subnodes.length&&this._branch)this._add2Sub(i);else if(this.objects.push(i),this.objects.length>this.maxObjects&&this._depth<this.maxDepth){for(this._split(),t=0;n=this.objects[t];t++)this._add2Sub(n);this.objects.length=0}},_add2Sub:function(t){var e,i=this._getIndex(t);for(e=0;e<i.length;e++)this.subnodes[i[e]].add(t)},_getIndex:function(t){var e=[],i=this.bounds.x+this.bounds.width/2,n=this.bounds.y+this.bounds.height/2,r=t.y<n&&t.y+t.height>=this.bounds.y,s=t.y+t.height>=n&&t.y<this.bounds.y+this.bounds.height;return t.x<i&&t.x+t.width>=this.bounds.x&&(r&&e.push(0),s&&e.push(2)),t.x+t.width>=i&&t.x<this.bounds.x+this.bounds.width&&(r&&e.push(1),s&&e.push(3)),e},_split:function(){if(this._branch=!0,!this.subnodes.length)for(var e=this.bounds.width/2|0,i=this.bounds.height/2|0,n=0;n<4;n++)this.subnodes[n]=t.quadtree({bounds:{x:this.bounds.x+(n%2===1?e:0),y:this.bounds.y+(n>=2?i:0),width:e,height:i},depth:this._depth+1,maxDepth:this.maxDepth,maxObjects:this.maxObjects,parent:this})}}}(kontra),function(t,e,i){t.vector=function(e,i){var n=Object.create(t.vector.prototype);return n._init(e,i),n},t.vector.prototype={_init:function(t,e){this._x=t||0,this._y=e||0},add:function(t,e){this._x+=(t.x||0)*(e||1),this._y+=(t.y||0)*(e||1)},clamp:function(t,e,n,r){this._clamp=!0,this._xMin=void 0!==t?t:-i,this._yMin=void 0!==e?e:-i,this._xMax=void 0!==n?n:i,this._yMax=void 0!==r?r:i},get x(){return this._x},get y(){return this._y},set x(t){this._x=this._clamp?e.min(e.max(this._xMin,t),this._xMax):t},set y(t){this._y=this._clamp?e.min(e.max(this._yMin,t),this._yMax):t}},t.sprite=function(e){var i=Object.create(t.sprite.prototype);return i.init(e),i},t.sprite.prototype={init:function(e){var i,n,r,s=this;e=e||{},s.position=s.position||t.vector(),s.velocity=s.velocity||t.vector(),s.acceleration=s.acceleration||t.vector(),s.position._init(e.x,e.y),s.velocity._init(e.dx,e.dy),s.acceleration._init(e.ddx,e.ddy),s.width=s.height=0;for(var a in e)s[a]=e[a];if(s.ttl=e.ttl||0,s.context=e.context||t.context,s.advance=s._advance,s.draw=s._draw,t._isImage(i=e.image))s.image=i,s.width=i.width,s.height=i.height,s.draw=s._drawImg;else if(i=e.animations){s.animations={};for(var o in i)n=i[o],s.animations[o]=n.clone?n.clone():n,r||(r=s.animations[o]);s.currentAnimation=r,s.width=r.width,s.height=r.height,s.advance=s._advanceAnim,s.draw=s._drawAnim}},get x(){return this.position.x},get y(){return this.position.y},get dx(){return this.velocity.x},get dy(){return this.velocity.y},get ddx(){return this.acceleration.x},get ddy(){return this.acceleration.y},set x(t){this.position.x=t},set y(t){this.position.y=t},set dx(t){this.velocity.x=t},set dy(t){this.velocity.y=t},set ddx(t){this.acceleration.x=t},set ddy(t){this.acceleration.y=t},isAlive:function(){return this.ttl>0},collidesWith:function(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y},update:function(t){this.advance(t)},render:function(){this.draw()},playAnimation:function(t){this.currentAnimation=this.animations[t]},_advance:function(t){this.velocity.add(this.acceleration,t),this.position.add(this.velocity,t),this.ttl--},_advanceAnim:function(t){this._advance(t),this.currentAnimation.update(t)},_draw:function(){this.context.fillStyle=this.color,this.context.fillRect(this.x,this.y,this.width,this.height)},_drawImg:function(){this.context.drawImage(this.image,this.x,this.y)},_drawAnim:function(){this.currentAnimation.render({context:this.context,x:this.x,y:this.y})}}}(kontra,Math,1/0),function(t){t.animation=function(e){var i=Object.create(t.animation.prototype);return i._init(e),i},t.animation.prototype={_init:function(t){t=t||{},this.spriteSheet=t.spriteSheet,this.frames=t.frames,this.frameRate=t.frameRate;var e=t.spriteSheet.frame;this.width=e.width,this.height=e.height,this.margin=e.margin||0,this._frame=0,this._accum=0},clone:function(){return t.animation(this)},update:function(t){for(t=t||1/60,this._accum+=t;this._accum*this.frameRate>=1;)this._frame=++this._frame%this.frames.length,this._accum-=1/this.frameRate},render:function(e){e=e||{};var i=e.context||t.context,n=this.frames[this._frame]/this.spriteSheet.framesPerRow|0,r=this.frames[this._frame]%this.spriteSheet.framesPerRow|0;i.drawImage(this.spriteSheet.image,r*this.width+(2*r+1)*this.margin,n*this.height+(2*n+1)*this.margin,this.width,this.height,e.x,e.y,this.width,this.height)}},t.spriteSheet=function(e){var i=Object.create(t.spriteSheet.prototype);return i._init(e),i},t.spriteSheet.prototype={_init:function(e){if(e=e||{},!t._isImage(e.image))throw Erorr("You must provide an Image for the SpriteSheet");this.animations={},this.image=e.image,this.frame={width:e.frameWidth,height:e.frameHeight,margin:e.frameMargin},this.framesPerRow=e.image.width/e.frameWidth|0,this.createAnimations(e.animations)},createAnimations:function(e){var i,n,r,s;for(var a in e){if(i=e[a],n=i.frames,r=i.frameRate,s=[],void 0===n)throw Error("Animation "+a+" must provide a frames property");Array.isArray(n)||(n=[n]);for(var o,h=0;o=n[h];h++)s.push.apply(s,this._parse(o));this.animations[a]=t.animation({spriteSheet:this,frames:s,frameRate:r})}},_parse:function(e){if(t._isNumber(e))return[e];var n=[],r=e.split(".."),s=i=+r[0],a=+r[1];if(s<a)for(;i<=a;i++)n.push(i);else for(;i>=a;i--)n.push(i);return n}}}(kontra),kontra.store={set:function(t,e){void 0===e?localStorage.removeItem(t):localStorage.setItem(t,JSON.stringify(e))},get:function(t){var e=localStorage.getItem(t);try{e=JSON.parse(e)}catch(i){}return e}},function(t,e,i){t.tileEngine=function(n){function r(t){var e,i;return"undefined"!=typeof t.x&&"undefined"!=typeof t.y?(e=j.getRow(t.y),i=j.getCol(t.x)):(e=t.row,i=t.col),e<0||i<0||e>=u||i>=c?-1:i+e*c}function s(t){for(var e,i,n=0,r=j.tilesets.length-1;n<=r;){if(e=(n+r)/2|0,i=j.tilesets[e],t>=i.firstGrid&&t<=i.lastGrid)return i;i.lastGrid<t?n=e+1:r=e-1}}function a(){for(var t,e,i,n,r,a,o,h,u,l,m=0;l=j.layers[_[m]];m++)for(var p=0,g=l.data.length;p<g;p++)t=l.data[p],t&&(e=s(t),i=e.image,n=p%c*d,r=(p/c|0)*f,h=t-e.firstGrid,u=i.width/d,a=h%u*d,o=(h/u|0)*f,v.drawImage(i,a,o,d,f,n,r,d,f))}if(n=n||{},!n.width||!n.height)throw Error("You must provide width and height properties");var o,h,c=n.width,u=n.height,d=n.tileWidth||n.tilewidth||32,f=n.tileHeight||n.tileheight||32,l=c*d,m=u*f,p=n.context||t.context,g=p.canvas.width,b=p.canvas.height,y=document.createElement("canvas"),v=y.getContext("2d"),x=e.max(0,l-g),w=e.max(0,m-b),_=[],j={width:c,height:u,tileWidth:d,tileHeight:f,mapWidth:l,mapHeight:m,context:p,x:n.x||0,y:n.y||0,tilesets:[],layers:{},addTilesets:function(e){i.isArray(e)||(e=[e]),e.forEach(function(e){var i,n,r,s,a,o=e.image;if(t._isImage(o))i=o;else if(t._isString(o))for(var h=1/0;h>=0;){h=o.lastIndexOf("/",h);var c=h<0?o:o.substr(h);if(t.assets.images[c]){i=t.assets.images[c];break}h--}if(!i)throw Error("You must provide an Image for the tileset");n=e.firstGrid,r=(i.width/d|0||1)*(i.height/f|0||1),n||(j.tilesets.length>0?(s=j.tilesets[j.tilesets.length-1],a=(s.image.width/d|0)*(s.image.height/f|0),n=s.firstGrid+a):n=1),j.tilesets.push({firstGrid:n,lastGrid:n+r-1,image:i}),j.tilesets.sort(function(t,e){return t.firstGrid-e.firstGrid})})},addLayers:function(t){i.isArray(t)||(t=[t]),t.forEach(function(t){t.render=void 0===t.render||t.render;var e,n,r,s,a,o;if(i.isArray(t.data[0]))for(e=[],n=0;r=t.data[n];n++)for(s=0;s<c;s++)e.push(r[s]||0);else e=t.data;j.layers[t.name]={data:e,zIndex:t.zIndex||0,render:t.render};for(a in t.properties){o=t.properties[a];try{o=JSON.parse(o)}catch(h){}j.layers[t.name][a]=o}j.layers[t.name].render&&(_.push(t.name),_.sort(function(t,e){return j.layers[t].zIndex-j.layers[e].zIndex}))}),a()},layerCollidesWith:function(t,e){for(var i,n=j.getRow(e.y),s=j.getCol(e.x),a=j.getRow(e.y+e.height),o=j.getCol(e.x+e.width),h=n;h<=a;h++)for(var c=s;c<=o;c++)if(i=r({row:h,col:c}),j.layers[t].data[i])return!0;return!1},tileAtLayer:function(t,e){var i=r(e);if(i>=0)return j.layers[t].data[i]},render:function(){j.context.drawImage(y,j.sx,j.sy,g,b,j.x,j.y,g,b)},renderLayer:function(t){for(var i,n,a,o,h,l,m,p,y,v=j.layers[t],x=j.getRow(),w=j.getCol(),_=r({row:x,col:w}),A=w*d-j.sx,O=x*f-j.sy,S=e.min(e.ceil(g/d)+1,c),I=e.min(e.ceil(b/f)+1,u),k=S*I,R=0;R<k;)a=v.data[_],a&&(o=s(a),h=o.image,i=A+R%S*d,n=O+(R/S|0)*f,l=a-o.firstGrid,m=h.width/d,p=l%m*d,y=(l/m|0)*f,j.context.drawImage(h,p,y,d,f,i,n,d,f)),++R%S===0?_=w+ ++x*c:_++},getRow:function(t){return t=t||0,(j.sy+t)/f|0},getCol:function(t){return t=t||0,(j.sx+t)/d|0},get sx(){return o},get sy(){return h},set sx(t){o=e.min(e.max(0,t),x)},set sy(t){h=e.min(e.max(0,t),w)},_layerOrder:_};j.sx=n.sx||0,j.sy=n.sy||0,y.width=l,y.height=m;for(var A in n.properties){var O=n.properties[A];try{O=JSON.parse(O)}catch(S){}j[A]=j[A]||O}return n.tilesets&&j.addTilesets(n.tilesets),n.layers&&j.addLayers(n.layers),j}}(kontra,Math,Array);